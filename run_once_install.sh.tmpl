#!/usr/bin/env bash
set -e

echo "=== Starting one-time setup ==="

# -------------------------------
# 1️⃣ Install Homebrew if missing
# -------------------------------
if ! command -v brew >/dev/null 2>&1; then
  echo "Installing Homebrew..."
  /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
else
  echo "Homebrew already installed"
fi
# Packages needed for your setup
brew install \
  git \
  tmux \
  neovim \
  alacritty \
  eza \
  fzf \
  fx \
  fd \
  ripgrep \
  zsh-autosuggestions \
  zsh-syntax-highlighting \
  font-jetbrains-mono-nerd-font

# Setup fzf keybindings & completion (idempotent)
"$(brew --prefix)/opt/fzf/install" --key-bindings --completion --no-update-rc

echo "Packages installed/updated via Homebrew"


# -------------------------------
# 4️⃣ Install Oh My Zsh
# -------------------------------
if [ ! -d "$HOME/.oh-my-zsh" ]; then
  echo "Installing Oh My Zsh..."
  RUNZSH=no CHSH=no sh -c "$(curl -fsSL https://raw.githubusercontent.com/ohmyzsh/ohmyzsh/master/tools/install.sh)"
else
  echo "Oh My Zsh already installed"
fi

# -------------------------------
# 5️⃣ Install Powerlevel10k
# -------------------------------
P10K_DIR="${ZSH_CUSTOM:-$HOME/.oh-my-zsh/custom}/themes/powerlevel10k"
if [ ! -d "$P10K_DIR" ]; then
  echo "Installing Powerlevel10k..."
  git clone --depth=1 https://github.com/romkatv/powerlevel10k.git "$P10K_DIR"
else
  echo "Powerlevel10k already installed"
fi

# -------------------------------
# 6️⃣ Update ~/.zshrc safely
# -------------------------------
ZSHRC="$HOME/.zshrc"

# Backup current zshrc
if [ ! -f "$ZSHRC.bak" ]; then
  cp "$ZSHRC" "$ZSHRC.bak" 2>/dev/null || true
fi

# Add minimal Powerlevel10k configuration
cat << 'EOF' >> "$ZSHRC"

# ===== Powerlevel10k setup =====
# Disable instant prompt to avoid blocking
typeset -g POWERLEVEL9K_INSTANT_PROMPT=quiet
export POWERLEVEL9K_DISABLE_INSTANT_PROMPT=true

# Load Oh My Zsh if installed
if [ -d "$HOME/.oh-my-zsh" ]; then
  source "$HOME/.oh-my-zsh/oh-my-zsh.sh"
fi

# Load Powerlevel10k theme
if [ -f "${ZSH_CUSTOM:-$HOME/.oh-my-zsh/custom}/themes/powerlevel10k/powerlevel10k.zsh-theme" ]; then
  source "${ZSH_CUSTOM:-$HOME/.oh-my-zsh/custom}/themes/powerlevel10k/powerlevel10k.zsh-theme"
fi

# Plugins
plugins=(git zsh-autosuggestions zsh-syntax-highlighting)
for plugin ($plugins); do
  if [ -f "${ZSH_CUSTOM:-$HOME/.oh-my-zsh/custom}/plugins/$plugin/$plugin.plugin.zsh" ]; then
    source "${ZSH_CUSTOM:-$HOME/.oh-my-zsh/custom}/plugins/$plugin/$plugin.plugin.zsh"
  fi
done

# Aliases
alias ll="ls -la"
alias gs="git status"

# Editor
export EDITOR="nvim"
EOF

echo "=== One-time setup complete! ==="
echo "Restart your terminal to apply changes."
echo "You can run 'p10k configure' once to customize your prompt."
